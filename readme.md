# ğŸ“‘ MCP-RAG åç«¯æ‰©å±•å¼€å‘è®¡åˆ’

## ğŸ¯ æ€»ä½“ç›®æ ‡
åŸºäºå·²æœ‰çš„ **MCP-RAG åç«¯**ï¼Œæ‰©å±•å‡ºä¸€ä¸ªå®Œæ•´çš„ **æ™ºèƒ½åŒ–æŠ•ç ”åˆ†æç³»ç»Ÿåç«¯**ï¼ŒåŒ…å«ï¼š  
- **æ•°æ®å»ºæ¨¡**ï¼šçœ‹æ¿ï¼ˆDashboardï¼‰ã€ç»„ä»¶ï¼ˆComponentï¼‰ã€æ•°æ®æºï¼ˆDatasourceï¼‰  
- **AI åŠ©æ‰‹**ï¼šMCP å·¥å…·è°ƒç”¨ï¼ˆæ•°æ®åº“æŸ¥è¯¢ + ç»˜å›¾ï¼‰  
- **æµå¼äº¤äº’**ï¼šæ”¯æŒå‰ç«¯å®æ—¶æ¥æ”¶ AI è¾“å‡º  
- **å‰ç«¯é…åˆè§„åˆ’**ï¼šçœ‹æ¿ç®¡ç†ï¼ˆä»¿ Supersetï¼‰+ AI åŠ©æ‰‹ï¼ˆä»¿ OpenBBï¼‰  

---

## ğŸ› ï¸ æ¨¡å—ä¸åŠŸèƒ½æ‹†è§£

### 1. æ•°æ®åº“ä¸ ORM
- **æ¨¡å—**ï¼šmodelsï¼ˆSQLAlchemyï¼‰
- **åŠŸèƒ½**ï¼š  
  - Dashboardï¼šåŒ…å«å¤šä¸ªç»„ä»¶  
  - Datasourceï¼šè¡¨/SQL æ•°æ®å®šä¹‰  
  - ColumnDefï¼šåˆ—è§’è‰²ï¼ˆç»´åº¦/åº¦é‡/OHLCï¼‰  
  - Componentï¼šç»‘å®šæ•°æ®æºï¼Œå®šä¹‰å›¾è¡¨ç±»å‹ä¸é…ç½®ï¼ˆencoding + markï¼‰
- **ä¾èµ–**ï¼šAlembic ç®¡ç†è¿ç§»

**API è®¾è®¡**  
- `POST /dashboards` åˆ›å»ºçœ‹æ¿  
- `GET /dashboards/{id}` è·å–çœ‹æ¿è¯¦æƒ…ï¼ˆå«ç»„ä»¶ï¼‰  
- `POST /datasources` åˆ›å»ºæ•°æ®æº  
- `POST /components` åˆ›å»ºç»„ä»¶  

---

### 2. MCP å·¥å…·ï¼šæ•°æ®åº“æŸ¥è¯¢
- **å·²æœ‰**ï¼š`db.describe`ã€`db.query`  
- **ä¼˜åŒ–**ï¼šå¢åŠ å¯¹ **chartContext** çš„æ”¯æŒï¼ˆåˆ—ç™½åå•ã€è§’è‰²è¿‡æ»¤ï¼‰

---

### 3. MCP å·¥å…·ï¼šç»˜å›¾
- **æ–°å¢å·¥å…·**ï¼š`plot.render`
- **åŠŸèƒ½**ï¼šå°† tabular æ•°æ®ï¼ˆrowsï¼‰+ encoding/mark â†’ è¾“å‡ºå›¾è¡¨  
  - æ–¹æ¡ˆ1ï¼šè¿”å› Vega-Lite Spec JSONï¼ˆå‰ç«¯æ¸²æŸ“ï¼‰  
  - æ–¹æ¡ˆ2ï¼šåç«¯ç”Ÿæˆ PNG base64ï¼ˆå¦‚ matplotlibï¼‰  
- **è¾“å…¥ç¤ºä¾‹**ï¼š
  ```json
  {
    "rows": [{"date": "2024-01-01", "close": 120}],
    "encoding": {"x": "date", "y": "close"},
    "mark": "line"
  }
  ```
- **è¾“å‡ºç¤ºä¾‹**ï¼š
  ```json
  { "ok": true, "spec": { "mark": "line", "encoding": {...} } }
  ```

---

### 4. AI äº¤äº’æµå¼è¾“å‡º
- **æ¥å£**ï¼š`POST /agent/stream`
- **æŠ€æœ¯**ï¼šServer-Sent Events (SSE)  
- **åŠŸèƒ½**ï¼šé€æ­¥è¾“å‡º AI å›å¤ï¼ˆæ–‡æœ¬ + å·¥å…·è°ƒç”¨è½¨è¿¹ï¼‰  
- **ä½œç”¨**ï¼šå‰ç«¯èƒ½åƒ ChatGPT ä¸€æ ·è¾¹æ”¶è¾¹æ˜¾ç¤º  

---

### 5. å‰ç«¯è§„åˆ’
- **æ¨¡å—åˆ’åˆ†**  
  - çœ‹æ¿ç®¡ç†ï¼ˆDashboardï¼‰ï¼šä»¿ Supersetï¼Œgrid å¸ƒå±€  
  - æ•°æ®æºç®¡ç†ï¼ˆDatasourceï¼‰ï¼šä»¿ Superset Dataset  
  - ç»„ä»¶é…ç½®ï¼ˆComponentï¼‰ï¼šé€‰æ‹©æ•°æ®æºã€é…ç½® encoding/mark  
  - AI åŠ©æ‰‹ï¼ˆAgentï¼‰ï¼šä»¿ OpenBBï¼Œç‹¬ç«‹äº¤äº’åŒºï¼Œæ”¯æŒå›¾è¡¨ç»“æœ  
- **äº¤äº’æµç¨‹**  
  - ç”¨æˆ·é€‰ç»„ä»¶ â†’ ç»‘å®šæ•°æ®æº â†’ æ¸²æŸ“å›¾è¡¨  
  - ç”¨æˆ·æé—® â†’ `/agent/stream` â†’ AI ç”Ÿæˆ SQL + å›¾è¡¨ spec â†’ å‰ç«¯æ¸²æŸ“  

---

## ğŸš€ åˆ†é˜¶æ®µå®ç°è®¡åˆ’

### Phase 1: åŸºç¡€æ•°æ®å»ºæ¨¡
- å»ºç«‹æ•°æ®åº“è¡¨ï¼šDashboard / Component / Datasource / ColumnDef  
- å®ç°åŸºç¡€ CRUD API  
- Alembic è¿ç§»è„šæœ¬  

### Phase 2: MCP æ•°æ®æŸ¥è¯¢
- æ¥å…¥ db.queryï¼Œæ”¯æŒ chartContext æ ¡éªŒ  
- å‰ç«¯èƒ½åŸºäºç»„ä»¶çš„æ•°æ®æºå–æ•°  

### Phase 3: MCP ç»˜å›¾å·¥å…·
- æ–°å¢ `plot.render`  
- AI å¯ä»¥å…ˆ query â†’ å† render â†’ è¿”å›å›¾è¡¨ spec  
- å‰ç«¯ç»„ä»¶æ”¯æŒæ¸²æŸ“ Vega-Lite spec  

### Phase 4: AI æµå¼äº¤äº’
- `/agent/stream` SSE æ¥å£  
- å‰ç«¯é€æ­¥å±•ç¤ºå›ç­”  

### Phase 5: å‰ç«¯é›†æˆ
- çœ‹æ¿é¡µé¢ï¼šç»„ä»¶æ¸²æŸ“ï¼ˆgrid å¸ƒå±€ï¼‰  
- æ•°æ®æºé¡µé¢ï¼šç®¡ç†è¡¨/SQL + åˆ—è§’è‰²  
- ç»„ä»¶é…ç½®é¢æ¿ï¼šencoding/mark é€‰æ‹©  
- AI åŠ©æ‰‹ï¼šå¯¹è¯åŒº + å›¾è¡¨ç»“æœ  

### Phase 6: æ‰©å±•ä¼˜åŒ–
- æ”¯æŒ K çº¿å›¾ï¼ˆOHLC roleï¼‰  
- æ”¯æŒå¤šç»„ä»¶ä¸Šä¸‹æ–‡ï¼ˆJOINï¼‰  
- å®¡è®¡æ—¥å¿—ï¼šä¿å­˜æ‰€æœ‰ AI è°ƒç”¨è½¨è¿¹  

---

## ğŸ”— æ¨¡å—ä¾èµ–å…³ç³»

```mermaid
graph TD

A[Datasource] --> B[ColumnDef]
B --> C[Component]
A --> C
C --> D[Dashboard]

subgraph MCP
  E[db.describe]
  F[db.query]
  G[plot.render]
end

C -->|chartContext| E
C -->|SQL Query| F
F -->|Rows| G
G -->|Spec| C
```

---

## ğŸ§° è¿ç»´è„šæœ¬ï¼ˆOpsï¼‰
- å¯é€‰ï¼šç»„ä»¶é…ç½®å¤šåºåˆ—è¿ç§»ï¼ˆå°†æ—§ç‰ˆå• y é…ç½®æŒä¹…åŒ–ä¸º encoding.seriesï¼‰  
  - è„šæœ¬ï¼š`backend/scripts/migrate_component_configs_to_multiseries.py`  
  - åŠŸèƒ½ï¼š
    - å°† legacy `encoding.y` â†’ `encoding.series = [{ y, label }]`
    - å°† legacy `encoding.color` â†’ `encoding._legacyColor`
    - å¯¹äº barï¼Œç¡®ä¿ `options.stacked` å­—æ®µå­˜åœ¨ï¼ˆé»˜è®¤ falseï¼‰
  - ç‰¹æ€§ï¼šå¹‚ç­‰ï¼›æ”¯æŒ `--dry-run` é¢„æ¼”ï¼›ä¸æ›´æ”¹ query_config
  - è¯´æ˜ï¼šåç«¯å·²åšã€Œè¯»æ—¶è¿ç§»ã€ï¼Œæœ¬è„šæœ¬ä»…ç”¨äºä¸€æ¬¡æ€§æŒä¹…åŒ–åˆ° DB
- æ•°æ®æºè¡¨ç»“æ„å¯¹é½ï¼ˆæ—§åº“ â†’ æ–°åº“å­—æ®µè¡¥é½ï¼‰  
  - è„šæœ¬ï¼š`backend/scripts/migrate_legacy_schema.py`  
  - åŠŸèƒ½ï¼šä¸º `datasources` è¡¨è¡¥é½ç¼ºå¤±åˆ—ä¸å¤–é”®ï¼Œå®‰å…¨é‡å¤æ‰§è¡Œ